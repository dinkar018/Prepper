generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_DATABASE_URL")
}

model User {
  id            String        @id @default(uuid())
  email         String        @unique
  name          String?
  password      String
  dateOfBirth   DateTime?
  guardiansName String?
  className     String?
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
  attempts      QuizAttempt[]
}

model Quiz {
  id          String           @id @default(uuid())
  title       String
  description String?
  createdAt   DateTime         @default(now())
  assessments QuizAssessment[]
  attempts    QuizAttempt[]
}

model Assessment {
  id        String           @id @default(uuid())
  name      String           @unique
  type      AssessmentType
  uiType    UIType
  questions Question[]
  quizzes   QuizAssessment[]
  traits    Trait[]
}

model QuizAssessment {
  quizId       String
  assessmentId String
  order        Int
  assessment   Assessment @relation(fields: [assessmentId], references: [id])
  quiz         Quiz       @relation(fields: [quizId], references: [id])

  @@id([quizId, assessmentId])
}

model Trait {
  id           String          @id @default(uuid())
  code         String
  name         String
  assessmentId String
  questions    QuestionTrait[]
  assessment   Assessment      @relation(fields: [assessmentId], references: [id])

  @@unique([code, assessmentId])
}

model Question {
  id           String          @id @default(uuid())
  text         String
  type         QuestionType
  assessmentId String
  createdAt    DateTime        @default(now())
  code         String
  options      Option[]
  assessment   Assessment      @relation(fields: [assessmentId], references: [id])
  traits       QuestionTrait[]
  responses    Response[]

  @@unique([code, assessmentId])
  @@index([assessmentId])
}

model Option {
  id         String     @id @default(uuid())
  text       String
  score      Int
  questionId String
  question   Question   @relation(fields: [questionId], references: [id])
  responses  Response[]
}

model QuestionTrait {
  questionId String
  traitId    String
  weight     Float    @default(1)
  question   Question @relation(fields: [questionId], references: [id])
  trait      Trait    @relation(fields: [traitId], references: [id])

  @@id([questionId, traitId])
}

model QuizAttempt {
  id            String        @id @default(uuid())
  userId        String
  quizId        String
  attemptNumber Int
  status        AttemptStatus @default(IN_PROGRESS)
  totalScore    Int?
  traitScores   Json?
  aiFeedback    String?
  createdAt     DateTime      @default(now())
  completedAt   DateTime?
  quiz          Quiz          @relation(fields: [quizId], references: [id])
  user          User          @relation(fields: [userId], references: [id])
  responses     Response[]

  @@unique([userId, quizId, attemptNumber])
}

model Response {
  id         String      @id @default(uuid())
  attemptId  String
  questionId String
  optionId   String
  attempt    QuizAttempt @relation(fields: [attemptId], references: [id])
  option     Option      @relation(fields: [optionId], references: [id])
  question   Question    @relation(fields: [questionId], references: [id])

  @@unique([attemptId, questionId])
}

enum AssessmentType {
  RIASEC
  BIG_FIVE
  RIVAN
}

enum UIType {
  SWIPE_CARD
  MCQ
  LIKERT
}

enum QuestionType {
  BINARY
  MCQ
}

enum AttemptStatus {
  IN_PROGRESS
  COMPLETED
  FAILED
}
